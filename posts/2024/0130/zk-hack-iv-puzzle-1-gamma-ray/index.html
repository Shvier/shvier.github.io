<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>ZK Hack IV Puzzle 1: Gamma Ray - Barry's Site</title><meta name=theme-color><meta name=description content="Bob was deeply inspired by the Zcash design 1 for private transactions and had some pretty cool ideas on how to adapt it for his requirements. He was also inspired by the Mina design for the lightest blockchain and wanted to combine the two. In order to achieve that, Bob used the MNT6753 cycle of curves to enable efficient infinite recursion, and used elliptic curve public keys to authorize spends."><meta name=author content="Barry's Site"><link rel="preload stylesheet" as=style href=https://shvier.github.io/main.min.css><link rel=preload as=image href=https://shvier.github.io/theme.png><link rel=preload as=image href=https://shvier.github.io/twitter.svg><link rel=preload as=image href=https://shvier.github.io/github.svg><script defer src=https://shvier.github.io/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous></script>
<script>document.addEventListener("DOMContentLoaded",()=>renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1}))</script><link rel=icon href=https://shvier.github.io/favicon.ico><link rel=apple-touch-icon href=https://shvier.github.io/apple-touch-icon.png><meta name=generator content="Hugo 0.111.3"><meta itemprop=name content="ZK Hack IV Puzzle 1: Gamma Ray"><meta itemprop=description content="Bob was deeply inspired by the Zcash design 1 for private transactions and had some pretty cool ideas on how to adapt it for his requirements. He was also inspired by the Mina design for the lightest blockchain and wanted to combine the two. In order to achieve that, Bob used the MNT6753 cycle of curves to enable efficient infinite recursion, and used elliptic curve public keys to authorize spends."><meta itemprop=datePublished content="2024-01-30T14:43:31-05:00"><meta itemprop=dateModified content="2024-08-22T20:08:38+00:00"><meta itemprop=wordCount content="456"><meta itemprop=keywords content><meta property="og:title" content="ZK Hack IV Puzzle 1: Gamma Ray"><meta property="og:description" content="Bob was deeply inspired by the Zcash design 1 for private transactions and had some pretty cool ideas on how to adapt it for his requirements. He was also inspired by the Mina design for the lightest blockchain and wanted to combine the two. In order to achieve that, Bob used the MNT6753 cycle of curves to enable efficient infinite recursion, and used elliptic curve public keys to authorize spends."><meta property="og:type" content="article"><meta property="og:url" content="https://shvier.github.io/posts/2024/0130/zk-hack-iv-puzzle-1-gamma-ray/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-30T14:43:31-05:00"><meta property="article:modified_time" content="2024-08-22T20:08:38+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ZK Hack IV Puzzle 1: Gamma Ray"><meta name=twitter:description content="Bob was deeply inspired by the Zcash design 1 for private transactions and had some pretty cool ideas on how to adapt it for his requirements. He was also inspired by the Mina design for the lightest blockchain and wanted to combine the two. In order to achieve that, Bob used the MNT6753 cycle of curves to enable efficient infinite recursion, and used elliptic curve public keys to authorize spends."><link rel=canonical href=https://shvier.github.io/posts/2024/0130/zk-hack-iv-puzzle-1-gamma-ray/></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-[--w] px-8 lg:justify-center"><div class="relative z-50 mr-auto flex items-center"><a class="-translate-y-[1px] text-2xl font-medium" href=https://shvier.github.io>Barry's Site</a><div class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10"><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/about/>About</a></nav><nav class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-14 lg:mt-0 lg:items-center"><a class="h-7 w-7 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./twitter.svg) href=https://twitter.com/barryllvm target=_blank rel=me>twitter</a>
<a class="h-7 w-7 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/Shvier target=_blank rel=me>github</a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-[--w] px-8 pb-16 pt-14 dark:prose-invert"><article><header class=mb-20><h1 class="!my-0 pb-2.5">ZK Hack IV Puzzle 1: Gamma Ray</h1><div class="text-sm opacity-50" style=display:flex;align-items:center><time>Created on Jan 30, 2024</time>
<time>&nbsp•&nbspModified on Aug 22, 2024</time></div></header><section><blockquote><p>Bob was deeply inspired by the Zcash design <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> for private transactions and had some pretty cool ideas on how to adapt it for his requirements. He was also inspired by the Mina design for the lightest blockchain and wanted to combine the two. In order to achieve that, Bob used the MNT6753 cycle of curves to enable efficient infinite recursion, and used elliptic curve public keys to authorize spends. He released a first version of the system to the world and Alice soon announced she was able to double spend by creating two different nullifiers for the same key&mldr;</p></blockquote><h2 id=puzzle-explanation>Puzzle Explanation</h2><p>We can find Bob&rsquo;s implementation of the spend transaction verification starting from <a href=https://github.com/ZK-Hack/puzzle-gamma-ray/blob/main/src/main.rs#L78>line 78</a>. Specifically, he builds a Merkle tree with the parameters from the circuit inputs (lines 78-94); then he validates the witness (private input), the secret key (\(s\)), less than the <code>MNT6BigFr</code> modulus (lines 96-98); next, he checks the hash value of the secret is equal to the public input, <code>nullifier</code> (lines 100-107); finally, he computes the public key through the scalar multiplication, \(s\cdot{G}\), and verifies the x coordinate of the public key is the member of the tree.<br>Thus, what the puzzle is asking is to find another <code>nullifier</code> that still satisfies the circuit.</p><h2 id=the-breakdown>The Breakdown</h2><p>The difference between Bob&rsquo;s implementation and Zcash is the elliptic curve. The curve that Zcash uses is a complete twisted Edwards elliptic curve, with the equation: \(a\cdot{x^2}+y^2=1+d\cdot{x^2}\cdot{y^2}\) <sup id=fnref1:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. Here I linked what a possible ctEdwards looks like in Figure 1.
<img src=https://upload.wikimedia.org/wikipedia/commons/thumb/3/3c/Edward-curves.svg/2880px-Edward-curves.svg.png alt>
<em>Figure 1. Edwards curves of equation x2 + y2 = 1 − d ·x2·y2 over the real numbers for d = 300 (red), d = √8 (yellow) and d = −0.9 (blue) <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></em></p><p>It is easy to see that any point excluding \((0,\pm 1)\) on the curve has order 4 with elements in the defined field, \(\mathbb{J}\). However, in Zcash, what is actually used is the subgroup of order, a prime number \(r_\mathbb{J}\), which implies the point \((0,-1)\) does not exist in \(\mathbb{J}^{(r)}\), since the order of \((0,-1)\) is 2 in \(\mathbb{J}\). With this fact and some other inductions, we can prove the Lemma 5.4.7 in Zcash. Therefore, it is secure to only validate the x coordinate of the point because each point is injective in \(\mathbb{J}^{(r)}\), i.e, given a valid point \((u,v)\), \((u,-v)\) is invalid.<br>On the contrary, in Bob&rsquo;s implementation, the curve is Miyaji–Nakabayashi–Takano, which is in Weierstrass form. That means \((u,-v)\) is valid if \((u,v)\) exists.</p><h2 id=the-solution>The Solution</h2><p>Based on the above exploration, the solution is clear to be found: compute the \((x,-y)\) by inverting \(s\cdot{G}\) and hash the result to get the new <code>nullifier</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span>    <span style=color:#66d9ef>let</span> inv_secret <span style=color:#f92672>=</span> <span style=color:#f92672>-</span>MNT6BigFr::from(leaked_secret.into_bigint());
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> secret_hack <span style=color:#f92672>=</span> MNT4BigFr::from(inv_secret.into_bigint());
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>let</span> nullifier_hack <span style=color:#f92672>=</span> <span style=color:#f92672>&lt;</span>LeafH <span style=color:#66d9ef>as</span> CRHScheme<span style=color:#f92672>&gt;</span>::evaluate(<span style=color:#f92672>&amp;</span>leaf_crh_params, [secret_hack]).unwrap();
</span></span></code></pre></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://zips.z.cash/protocol/protocol.pdf>https://zips.z.cash/protocol/protocol.pdf</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a>&#160;<a href=#fnref1:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://en.wikipedia.org/wiki/Edwards_curve>https://en.wikipedia.org/wiki/Edwards_curve</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></section><nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]"><a class="flex w-1/2 items-center rounded-l-md p-6 pr-3 no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]" href=https://shvier.github.io/posts/2024/0131/zk-hack-iv-puzzle-2-supervillain/><span class=mr-1.5>←</span><span>ZK Hack IV Puzzle 2: Supervillain</span></a>
<a class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]" href=https://shvier.github.io/posts/2023/0718/proof-of-solvency-with-zk-snark/><span>Proof of Liability with zk-SNARKs, Re-explained</span><span class=ml-1.5>→</span></a></nav></article></main><footer class="opaco mx-auto flex h-[5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-50"><div class=mr-auto>&copy; 2024
<a class=link href=https://shvier.github.io>Barry's Site</a></div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>Powered by Hugo️️</a>️
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>Theme Paper</a>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/katex.min.css integrity="sha512-mQwom8Ns4op+H29oDkD/LXO/OsXPvCFfkgZkFAVrhhePzRLU8NUI3Nkm43NhWUSmj3p5Cca2HTEkMQmXQRwDQQ==" crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/katex.min.js integrity="sha512-sHSNLECRJSK+BFs7E8DiFc6pf6n90bLI85Emiw1jhreduZhK3VXgq9l4kAt9eTIHYAcuQBKHL01QKs4/3Xgl8g==" crossorigin=anonymous referrerpolicy=no-referrer></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/contrib/auto-render.min.js integrity="sha512-iWiuBS5nt6r60fCz26Nd0Zqe0nbk1ZTIQbl3Kv7kYsX+yKMUFHzjaH2+AnM6vp2Xs+gNmaBAVWJjSmuPw76Efg==" crossorigin=anonymous referrerpolicy=no-referrer onload=renderMathInElement(document.body)></script></footer></body></html>