<!doctype html><html class="not-ready lg:text-base" style=--bg:#faf8f1 lang=en-us><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>ZK Hack IV Puzzle 2: Supervillain - Barry's Site</title>
<meta name=theme-color><meta name=description content="Bob has been designing a new optimized signature scheme for his L1 based on BLS signatures. Specifically, he wanted to be able to use the most efficient form of BLS signature aggregation, where you just add the signatures together rather than having to delinearize them. In order to do that, he designed a proof-of-possession scheme based on the B-KEA assumption he found in the the Sapling security analysis paper by Mary Maller 1."><meta name=author content="Barry's Site"><link rel="preload stylesheet" as=style href=https://shvier.github.io/main.min.css><link rel=preload as=image href=https://shvier.github.io/theme.png><link rel=preload as=image href=https://shvier.github.io/twitter.svg><link rel=preload as=image href=https://shvier.github.io/github.svg><script defer src=https://shvier.github.io/highlight.min.js onload=hljs.initHighlightingOnLoad()></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script><script>MathJax={tex:{displayMath:[["\\[","\\]"],["$$","$$"]],inlineMath:[["\\(","\\)"],["$","$"]]}}</script><link rel=icon href=https://shvier.github.io/favicon.ico><link rel=apple-touch-icon href=https://shvier.github.io/apple-touch-icon.png><meta name=generator content="Hugo 0.126.1"><meta itemprop=name content="ZK Hack IV Puzzle 2: Supervillain"><meta itemprop=description content="Bob has been designing a new optimized signature scheme for his L1 based on BLS signatures. Specifically, he wanted to be able to use the most efficient form of BLS signature aggregation, where you just add the signatures together rather than having to delinearize them. In order to do that, he designed a proof-of-possession scheme based on the B-KEA assumption he found in the the Sapling security analysis paper by Mary Maller 1."><meta itemprop=datePublished content="2024-01-31T14:41:24-05:00"><meta itemprop=dateModified content="2024-08-22T20:21:49+00:00"><meta itemprop=wordCount content="829"><meta property="og:url" content="https://shvier.github.io/posts/2024/0131/zk-hack-iv-puzzle-2-supervillain/"><meta property="og:site_name" content="Barry's Site"><meta property="og:title" content="ZK Hack IV Puzzle 2: Supervillain"><meta property="og:description" content="Bob has been designing a new optimized signature scheme for his L1 based on BLS signatures. Specifically, he wanted to be able to use the most efficient form of BLS signature aggregation, where you just add the signatures together rather than having to delinearize them. In order to do that, he designed a proof-of-possession scheme based on the B-KEA assumption he found in the the Sapling security analysis paper by Mary Maller 1."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-01-31T14:41:24-05:00"><meta property="article:modified_time" content="2024-08-22T20:21:49+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="ZK Hack IV Puzzle 2: Supervillain"><meta name=twitter:description content="Bob has been designing a new optimized signature scheme for his L1 based on BLS signatures. Specifically, he wanted to be able to use the most efficient form of BLS signature aggregation, where you just add the signatures together rather than having to delinearize them. In order to do that, he designed a proof-of-possession scheme based on the B-KEA assumption he found in the the Sapling security analysis paper by Mary Maller 1."><link rel=canonical href=https://shvier.github.io/posts/2024/0131/zk-hack-iv-puzzle-2-supervillain/></head><body class="text-black duration-200 ease-out dark:text-white"><header class="mx-auto flex h-[4.5rem] max-w-[--w] px-8 lg:justify-center"><div class="relative z-50 mr-auto flex items-center"><a class="-translate-y-[1px] text-2xl font-medium" href=https://shvier.github.io/>Barry's Site</a><div class="btn-dark text-[0] ml-4 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]" role=button aria-label=Dark></div></div><div class="btn-menu relative z-50 -mr-8 flex h-[4.5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden" role=button aria-label=Menu></div><script>const htmlClass=document.documentElement.classList;setTimeout(()=>{htmlClass.remove("not-ready")},10);const btnMenu=document.querySelector(".btn-menu");btnMenu.addEventListener("click",()=>{htmlClass.toggle("open")});const metaTheme=document.querySelector('meta[name="theme-color"]'),lightBg="#faf8f1".replace(/"/g,""),setDark=e=>{metaTheme.setAttribute("content",e?"#000":lightBg),htmlClass[e?"add":"remove"]("dark"),localStorage.setItem("dark",e)},darkScheme=window.matchMedia("(prefers-color-scheme: dark)");if(htmlClass.contains("dark"))setDark(!0);else{const e=localStorage.getItem("dark");setDark(e?e==="true":darkScheme.matches)}darkScheme.addEventListener("change",e=>{setDark(e.matches)});const btnDark=document.querySelector(".btn-dark");btnDark.addEventListener("click",()=>{setDark(localStorage.getItem("dark")!=="true")})</script><div class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"><nav class="lg:ml-12 lg:flex lg:flex-row lg:items-center lg:space-x-10"><a class="block text-center text-xl leading-[5rem] lg:text-base lg:font-normal" href=/about/>About</a></nav><nav class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-14 lg:mt-0 lg:items-center"><a class="h-7 w-7 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./twitter.svg) href=https://twitter.com/barryllvm target=_blank rel=me>twitter
</a><a class="h-7 w-7 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6" style=--url:url(./github.svg) href=https://github.com/Shvier target=_blank rel=me>github</a></nav></div></header><main class="prose prose-neutral relative mx-auto min-h-[calc(100%-9rem)] max-w-[--w] px-8 pb-16 pt-14 dark:prose-invert"><article><header class=mb-20><h1 class="!my-0 pb-2.5">ZK Hack IV Puzzle 2: Supervillain</h1><div class="text-sm opacity-50" style=display:flex;align-items:center><time>Created on Jan 31, 2024</time>
<time>&nbsp•&nbspModified on Aug 22, 2024</time></div></header><section><blockquote><p>Bob has been designing a new optimized signature scheme for his L1 based on BLS signatures. Specifically, he wanted to be able to use the most efficient form of BLS signature aggregation, where you just add the signatures together rather than having to delinearize them. In order to do that, he designed a proof-of-possession scheme based on the B-KEA assumption he found in the the Sapling security analysis paper by Mary Maller <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. Based the reasoning in the Power of Proofs-of-Possession paper <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>, he concluded that his scheme would be secure. After he deployed the protocol, he found it was attacked and there was a malicious block entered the system, fooling all the light nodes&mldr;</p></blockquote><h2 id=puzzle-explanation>Puzzle Explanation</h2><h4 id=bls-signature>BLS Signature</h4><p>BLS signature is a cryptographic protocol that uses a pairing-friendly elliptic curve to implement the digital signature algorithm. Like ElGamal signature based on the hardness of discrete logarithm problem, BLS relies on the property of an elliptic curve that it is infeasible to reverse the computation of a point, or find \(s\) such that \(g^s=p\) given \(g\) and \(p\), where \(g\) is a generator of the curve group and \(p\) is a point on the curve. Note there is no exponent calculation in elliptic curve, I just use this notation. We can say \(p\) is the public key while \(s\) is the secret. The signing algorithm is \(\sigma=H(m)^s\), where \(\sigma\) is the signature, \(H\) is a hash function and \(m\) is the message we want to sign; the verification uses a bilinear pairing: \(e(p,H(m))\stackrel{?}{=}e(g,\sigma)\). The equation holds because \(e(p,H(m))=e(g^s,H(m))=e(g,H(m)^s)=e(g,\sigma)\). For more details on why pairing can work in this way, read <a href=https://static1.squarespace.com/static/5fdbb09f31d71c1227082339/t/5ff394720493bd28278889c6/1609798774687/PairingsForBeginners.pdf>this paper</a>.</p><h4 id=bls-signature-aggregation>BLS Signature Aggregation</h4><p>One of the powerful features BLS provides is multi-signing, which enables us to aggregate several individual signatures to verify them at once to reduce computation and data transmission. To do so, add all the signatures to get a new signature and the public keys to get a new key, and, that is it! This works because BLS signature is homomorphic additive. Specifically, assume we add two public keys \(p_1,p_2\) and two signatures \(\sigma_1,\sigma_2\), we can find that \(e(p_1+p_2,H(m))=e(g^{s_1},H(m))+e(g^{s_2},H(m))=e(g,H(m)^{s_1})+e(g,H(m)^{s_2})=e(g,\sigma_1+\sigma_2)\).</p><h4 id=rogue-key-attack>Rogue Key Attack</h4><p>In the previous section, we explained how BLS signature aggregation works. Due to its homomorphic addition, an adversary can forge others&rsquo; signatures to pretend they are signing the message together. The idea is the attacker chooses a secret and the corresponding public key can cancel all the other public keys, e.g., \(s^\prime=\alpha-\sum{s_i}\), so that the multi-signature becomes \(H(m)^{s^\prime+\sum{s_i}}=H(m)^\alpha\) and the aggregated public key becomes \(p^\prime+\sum{p_i}=g^\alpha\). This way, the adversary successfully fools others. That is the reason why we need to delinearize the individual signatures when aggregation. There is also <a href=https://crypto.stanford.edu/~dabo/pubs/papers/BLSmultisig.html>a modified version of BLS signature</a> that aims to fix this issue.</p><h4 id=b-kea>B-KEA</h4><p>The B-KEA is the bilinear pairing edition of the KEA, knowledge-of-exponent assumption. Roughly speaking, KEA describes a similar computational Diffie-Hellman problem for the theory of zero knowledge, but the difference is the prover does not need to show the exponent. Instead, he proves the knowledge of that exponent. For example, if a malicious prover wants to show the knowledge of \(c\) that \(y=g^c\), he can open \(y^b=(g^c)^b\) and \(g^b\). Obviously, it is not such hard as CDH, so there are revisions to this assumption. For more information, read <a href=https://eprint.iacr.org/2004/008.pdf>this paper</a>.<br>Back to the B-KEA, the assumption says showing \(C, \hat{C}\) such that \(e(C,h)=e(g,\hat{C})\) proves \(s_1\) and \(s_2\) are identical where \((C,\hat{C})=(g^{s_1},h^{s_2})\) <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> (The original assumption describes this statement more rigorously but this is a simple version to understand the assumption).</p><h2 id=the-breakdown>The Breakdown</h2><p>From the description of the B-KEA, we can see the assumption shows the two numbers are identical rather than the knowledge of the numbers per se. Thus, Bob&rsquo;s implementation cannot ignore the delinearization when aggregating several signatures. Another mistake he makes is the way of signing is simple to be forged. He only multiplies the sequence number by the signature, \(\sum{R\cdot{(i+1)}\cdot{s_i}}\). One solution to prevent the attack is to make each coefficient different when aggregating, e.g., \(\sum{H(p_i)\cdot{s_i}}\), so that the adversary cannot cancel others&rsquo; signatures because of the unequal coefficients (Actually this is the idea of the modified version of BLS signature mentioned above).</p><h2 id=the-solution>The Solution</h2><p>Based on the above description, our solution came out:</p><ol><li>Create a secret key and compute the corresponding proof of knowledge key<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>let</span> secret_hack <span style=color:#f92672>=</span> Fr::from(<span style=color:#ae81ff>123</span>);
</span></span><span style=display:flex><span><span style=color:#75715e>// R*(n+1)*s
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>let</span> pok_hack <span style=color:#f92672>=</span> derive_point_for_pok(new_key_index).mul(secret_hack);
</span></span></code></pre></div></li><li>Compute the public key, \(pk\_hack-\sum{pk_i}\), to cancel others<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>let</span> pk_hack <span style=color:#f92672>=</span> G1Affine::generator().mul(secret_hack);
</span></span><span style=display:flex><span><span style=color:#66d9ef>let</span> new_key <span style=color:#f92672>=</span> public_keys
</span></span><span style=display:flex><span>    .iter()
</span></span><span style=display:flex><span>    .fold(G1Projective::from(pk_hack), <span style=color:#f92672>|</span>acc, (pk, _)<span style=color:#f92672>|</span> acc <span style=color:#f92672>-</span> pk)
</span></span><span style=display:flex><span>    .into_affine();
</span></span></code></pre></div></li><li>When aggregating the adversary&rsquo;s signature, we add \(R\cdot(n+1)\cdot{secret\_hack}\). The aggregated signature becomes: \(R\cdot(n+1)\cdot(secret\_hack+\sum{s_i})=R\cdot(n+1)\cdot{secret\_hack}+\sum{s_i\cdot{R\cdot(n+1)}}\). Recall that \(\pi_i=s_i\cdot{R}\cdot(i+1)\), so the second term of the equation becomes \(\sum{\pi_i\cdot(n+1)\cdot(i+1)^{-1}}\)<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>let</span> new_proof <span style=color:#f92672>=</span> public_keys
</span></span><span style=display:flex><span>    .iter()
</span></span><span style=display:flex><span>    .enumerate()
</span></span><span style=display:flex><span>    .map(<span style=color:#f92672>|</span>(i, (_, proof))<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// pi*(n+1)*(i+1)^-1
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        proof.mul(Fr::from(new_key_index <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>u64</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>) <span style=color:#f92672>*</span> Fr::from(i <span style=color:#66d9ef>as</span> <span style=color:#66d9ef>u64</span> <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>).inverse().unwrap())
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    .fold(pok_hack, <span style=color:#f92672>|</span>acc, proof<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// R*(n+1)*s - sum_{pi*(n+1)*(i+1)-1}
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        acc <span style=color:#f92672>-</span> proof
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    .into_affine();
</span></span></code></pre></div></li><li>Finally, sign the message with the adversary&rsquo;s private key<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#66d9ef>let</span> aggregate_signature <span style=color:#f92672>=</span> bls_sign(secret_hack, message);
</span></span></code></pre></div></li></ol><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a href=https://github.com/zcash/sapling-security-analysis/blob/master/MaryMallerUpdated.pdf>https://github.com/zcash/sapling-security-analysis/blob/master/MaryMallerUpdated.pdf</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://rist.tech.cornell.edu/papers/pkreg.pdf>https://rist.tech.cornell.edu/papers/pkreg.pdf</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://eprint.iacr.org/2017/599.pdf>https://eprint.iacr.org/2017/599.pdf</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></section><nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]"><a class="flex w-1/2 items-center rounded-l-md p-6 pr-3 no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]" href=https://shvier.github.io/posts/2024/0813/a-brief-introduction-to-secure-multiparty-computation/><span class=mr-1.5>←</span><span>A Brief Introduction to Secure Multiparty Computation (MPC)</span></a>
<a class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]" href=https://shvier.github.io/posts/2024/0130/zk-hack-iv-puzzle-1-gamma-ray/><span>ZK Hack IV Puzzle 1: Gamma Ray</span><span class=ml-1.5>→</span></a></nav></article></main><footer class="opaco mx-auto flex h-[5rem] max-w-3xl items-center px-8 text-[0.9em] opacity-50"><div class=mr-auto>&copy; 2024
<a class=link href=https://shvier.github.io/>Barry's Site</a></div><a class="link mx-6" href=https://gohugo.io/ rel=noopener target=_blank>Powered by Hugo️️</a>️
<a class=link href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>Theme Paper</a>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/katex.min.css integrity="sha512-mQwom8Ns4op+H29oDkD/LXO/OsXPvCFfkgZkFAVrhhePzRLU8NUI3Nkm43NhWUSmj3p5Cca2HTEkMQmXQRwDQQ==" crossorigin=anonymous referrerpolicy=no-referrer><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/katex.min.js integrity="sha512-sHSNLECRJSK+BFs7E8DiFc6pf6n90bLI85Emiw1jhreduZhK3VXgq9l4kAt9eTIHYAcuQBKHL01QKs4/3Xgl8g==" crossorigin=anonymous referrerpolicy=no-referrer></script><script src=https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.4/contrib/auto-render.min.js integrity="sha512-iWiuBS5nt6r60fCz26Nd0Zqe0nbk1ZTIQbl3Kv7kYsX+yKMUFHzjaH2+AnM6vp2Xs+gNmaBAVWJjSmuPw76Efg==" crossorigin=anonymous referrerpolicy=no-referrer onload=renderMathInElement(document.body)></script></footer></body></html>